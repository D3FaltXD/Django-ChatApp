{% extends "chat/base.html" %} {% load crispy_forms_tags %} {% block content %}
<div class="content-section">
  <h3 class="text-center">{{room_name}}</h3>
  <div
    id="chat-log"
    class="container bg-light p-3 rounded-sm border rounded"
    style="height: 450px"
  >
    <article class="media content-section">
      <img
        class="rounded-circle article-img"
        src="{{ user.profile.image.url }}"
      />
      <div class="media-body">
        <div class="article-metadata">
          <span class="mr-2">{{user.username}}</span>
        </div>

        <p class="article-content">sdagdgdsg artc</p>
      </div>
    </article>

    <article class="media content-section">
      <img
        class="rounded-circle article-img"
        src="{{ user.profile.image.url }}"
      />
      <div class="media-body">
        <div class="article-metadata">
          <span class="mr-2">{{user.username}}</span>
        </div>

        <p class="article-content">sdagdgdsg artc</p>
      </div>
    </article>
  </div>

  <br />
  <input
    class="form-control"
    id="chat-message-input"
    type="text"
    size="100"
  /><br />
  <input
    class="form-control"
    id="chat-message-submit"
    type="button"
    value="Send"
  />

  {{ room_name|json_script:"room-name" }}
  <script>
    const roomName = JSON.parse(
      document.getElementById('room-name').textContent
    );

    const chatSocket = new WebSocket(
      'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      document.querySelector('#chat-log').value += data.message + '\n';
    };

    chatSocket.onclose = function (e) {
      console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
      if (e.keyCode === 13) {
        // enter, return
        document.querySelector('#chat-message-submit').click();
      }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
      const messageInputDom = document.querySelector('#chat-message-input');
      const message = messageInputDom.value;
      chatSocket.send(
        JSON.stringify({
          message: message,
        })
      );
      messageInputDom.value = '';
    };
  </script>
</div>
{% endblock content %}
